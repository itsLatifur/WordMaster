<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WordsMaster - Word Guessing Game</title>
    <!-- External CSS Libraries -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <!-- Local CSS Files -->
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="css/animations.css" />

    <!-- Favicon -->
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéØ</text></svg>"
    />

    <!-- PWA Manifest & Theme Color -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#275e66" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <link
      rel="apple-touch-icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéØ</text></svg>"
    />
  </head>

  <body>
    <!-- Animated Background -->
    <div id="background" aria-hidden="true"></div>

    <!-- Loading Screen -->
    <div
      id="loadingScreen"
      class="loading-screen"
      role="dialog"
      aria-label="Loading game"
    >
      <div class="loading-content">
        <div class="loading-logo" aria-label="WordsMaster">WordsMaster</div>
        <div class="spinner" aria-label="Loading"></div>
      </div>
    </div>

    <!-- Rules Modal -->
    <div
      id="rulesModal"
      class="modal fade"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="rulesModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="rulesModalLabel">
              Game Rules & Settings
            </h5>
          </div>
          <div class="modal-body">
            <section aria-labelledby="howToPlayHeading">
              <h6 id="howToPlayHeading">How to Play:</h6>
              <ul>
                <li>Unscramble the words before time runs out</li>
                <li>3 Hearts = 3 wrong attempts</li>
                <li>Use hints to reveal letters (3 hints per game)</li>
                <li>Difficulty levels change word count and time</li>
              </ul>
            </section>

            <section aria-labelledby="audioSettingsHeading">
              <h6 id="audioSettingsHeading">Audio Settings:</h6>
              <div class="mb-3">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="musicCheck"
                    checked
                  />
                  <label class="form-check-label" for="musicCheck">
                    Background Music
                    <i class="bi bi-music-note" aria-hidden="true"></i>
                  </label>
                </div>
                <div class="mt-2">
                  <label class="form-label" for="volumeSlider"
                    >Music Volume</label
                  >
                  <input
                    type="range"
                    class="form-range"
                    id="volumeSlider"
                    min="0"
                    max="100"
                    value="50"
                    aria-label="Music volume"
                  />
                </div>
              </div>

              <div class="mb-3">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="sfxCheck"
                    checked
                  />
                  <label class="form-check-label" for="sfxCheck">
                    Sound Effects
                    <i class="bi bi-speaker" aria-hidden="true"></i>
                  </label>
                </div>
              </div>
            </section>
          </div>
          <div class="modal-footer justify-content-center">
            <button
              type="button"
              class="btn btn-primary w-50"
              onclick="startGameAfterRules()"
            >
              Let's Play!
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Top UI Elements -->
    <header>
      <h1 class="game-logo" aria-label="WordsMaster Game">WordsMaster</h1>
      <div class="high-score" aria-label="Current high score">
        üèÜ Highest Score: <span id="highScoreValue">0</span>
      </div>
    </header>

    <!-- Main Game Container -->
    <main class="container">
      <!-- Start Section -->
      <section
        id="startSection"
        class="container-box"
        aria-labelledby="startSectionHeading"
      >
        <h2 id="startSectionHeading" class="text-center mb-4">
          Choose Difficulty Level
        </h2>
        <div class="box">
          <label for="difficulty" class="form-label">Game Mode:</label>
          <select
            id="difficulty"
            class="form-select"
            aria-describedby="difficultyHelp"
          >
            <option value="easy">Easy (5 words - 2:00 minutes)</option>
            <option value="medium">Medium (10 words - 2:30 minutes)</option>
            <option value="hard">Hard (20 words - 3:00 minutes)</option>
          </select>
          <div id="difficultyHelp" class="form-text">
            Choose your challenge level
          </div>
        </div>
        <button
          class="btn btn-primary w-100 mt-3"
          onclick="startGame()"
          aria-describedby="startButtonHelp"
        >
          Start Game
        </button>
        <div id="startButtonHelp" class="form-text text-center mt-2">
          Begin your word unscrambling adventure!
        </div>
      </section>

      <!-- Perfect Game Popup -->
      <div
        id="perfectPopup"
        class="popup hidden"
        role="dialog"
        aria-labelledby="perfectTitle"
        aria-modal="true"
      >
        <button
          class="close-popup"
          aria-label="Close perfect game notification"
        >
          &times;
        </button>
        <h2 id="perfectTitle">PERFECT GAME!</h2>
        <p>Amazing! You solved all words without using any hints!</p>
      </div>

      <!-- High Score Popup -->
      <div
        id="highscorePopup"
        class="popup hidden"
        role="dialog"
        aria-labelledby="highscoreTitle"
        aria-modal="true"
      >
        <button class="close-popup" aria-label="Close high score notification">
          &times;
        </button>
        <h2 id="highscoreTitle">NEW RECORD!</h2>
        <p>Congratulations! You've set a new high score!</p>
      </div>

      <!-- Game Section -->
      <section
        id="gameSection"
        class="container-box hidden"
        aria-labelledby="gameSectionHeading"
      >
        <h2 id="gameSectionHeading" class="sr-only">Game Play Area</h2>

        <!-- Game Stats -->
        <div class="row g-3 mb-4 hud" role="group" aria-label="Game statistics">
          <div class="col-6 col-md-3 box text-center">
            <div class="text-muted small">Time Left</div>
            <div id="timer" class="fw-bold" aria-live="polite">02:00</div>
            <div
              class="time-progress progress neon mt-2"
              role="progressbar"
              aria-label="Time remaining"
              aria-valuemin="0"
              aria-valuemax="100"
            >
              <div id="timeBar" class="progress-bar"></div>
            </div>
          </div>
          <div class="col-6 col-md-3 box text-center">
            <div class="text-muted small">Score</div>
            <div class="score-readout">
              <span id="score" aria-live="polite">0</span>
            </div>
            <div id="streakBadge" class="streak-badge mt-2" aria-live="polite">
              x0 Combo
            </div>
          </div>
          <div class="col-6 col-md-3 box text-center">
            <div class="text-muted small">Progress</div>
            <div id="wordCount" aria-live="polite">0/5</div>
            <div
              class="word-progress progress neon mt-2"
              role="progressbar"
              aria-label="Word progress"
              aria-valuemin="0"
              aria-valuemax="100"
            >
              <div id="wordProgressBar" class="progress-bar"></div>
            </div>
          </div>
          <div class="col-6 col-md-3 box text-center">
            <div class="text-muted small">Lives</div>
            <div id="lives" aria-live="polite" aria-label="3 lives remaining">
              ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è
            </div>
          </div>
        </div>

        <!-- Current Word Display -->
        <div class="box text-center">
          <label for="scrambledWord" class="text-muted small"
            >Current Scrambled Word</label
          >
          <div
            id="scrambledWord"
            class="word-box tiles mt-2"
            aria-live="polite"
            role="main"
          ></div>
          <div
            id="hintArea"
            class="text-muted small mt-2"
            aria-live="polite"
            aria-label="Hint area"
          ></div>
        </div>

        <!-- Answer Input -->
        <div class="box">
          <label for="userInput" class="sr-only">Your answer</label>
          <input
            type="text"
            id="userInput"
            class="form-control form-control-lg"
            placeholder="Type your answer here..."
            autocomplete="off"
            aria-describedby="inputHelp"
          />
          <div id="inputHelp" class="form-text">
            Unscramble the letters to form a word
          </div>
        </div>

        <!-- Game Action Buttons -->
        <div
          class="d-grid gap-2 d-md-flex justify-content-md-between mt-3"
          role="group"
          aria-label="Game actions"
        >
          <button
            class="btn btn-success"
            onclick="submitAnswer()"
            aria-describedby="submitHelp"
          >
            <i class="bi bi-check-circle" aria-hidden="true"></i> Submit Answer
          </button>
          <button
            class="btn btn-info"
            onclick="useHint()"
            aria-describedby="hintHelp"
          >
            <i class="bi bi-lightbulb" aria-hidden="true"></i>
            <span id="hintButtonText">Hint (3 left)</span>
          </button>
          <button
            class="btn btn-warning"
            onclick="skipWord()"
            aria-describedby="skipHelp"
          >
            <i class="bi bi-skip-forward" aria-hidden="true"></i> Skip Word
          </button>
        </div>
      </section>

      <!-- Statistics Section -->
      <section
        id="statsSection"
        class="container-box hidden"
        aria-labelledby="statsSectionHeading"
      >
        <h2 id="statsSectionHeading" class="text-center mb-4">Game Results</h2>
        <div class="table-responsive">
          <table
            class="table table-striped table-hover"
            aria-label="Detailed game statistics"
          >
            <caption class="sr-only">
              Your performance breakdown for this game
            </caption>
            <tbody>
              <tr>
                <th scope="row">Total Words</th>
                <td>
                  <span id="statTotal" aria-label="Total words in game">0</span>
                </td>
              </tr>
              <tr>
                <th scope="row">Words Solved</th>
                <td>
                  <span id="statSolved" aria-label="Number of words solved"
                    >0</span
                  >
                  (<span
                    id="solvedWords"
                    class="text-muted"
                    aria-label="List of solved words"
                  ></span
                  >)
                </td>
              </tr>
              <tr>
                <th scope="row">Words Missed</th>
                <td>
                  <span id="statMissed" aria-label="Number of words missed"
                    >0</span
                  >
                  (<span
                    id="missedWords"
                    class="text-muted"
                    aria-label="List of missed words"
                  ></span
                  >)
                </td>
              </tr>
              <tr>
                <th scope="row">Success Rate</th>
                <td>
                  <span
                    id="statPercentage"
                    aria-label="Percentage of words solved"
                    >0</span
                  >%
                </td>
              </tr>
              <tr>
                <th scope="row">Bonus Points</th>
                <td>
                  +<span id="timeBonus" aria-label="Bonus points earned"
                    >0</span
                  >
                  points
                </td>
              </tr>
              <tr>
                <th scope="row">Longest Streak</th>
                <td>
                  <span
                    id="statStreak"
                    aria-label="Longest consecutive correct answers"
                    >0</span
                  >
                </td>
              </tr>
              <tr class="table-primary">
                <th scope="row">Final Score</th>
                <td>
                  <strong
                    ><span id="finalScore" aria-label="Your final score"
                      >0</span
                    ></strong
                  >
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <button class="btn btn-primary w-100 mt-3" onclick="playAgain()">
          <i class="bi bi-arrow-repeat" aria-hidden="true"></i> Play Again
        </button>
      </section>
    </main>

    <!-- Sound Control -->
    <aside class="sound-control" aria-label="Audio controls">
      <button
        id="soundToggle"
        class="btn btn-sm btn-outline-secondary"
        aria-label="Toggle sound on/off"
        title="Toggle Audio"
        type="button"
      >
        <i class="bi bi-volume-up" aria-hidden="true"></i>
      </button>
      <div
        id="volumePanel"
        class="volume-panel hidden"
        role="dialog"
        aria-label="Volume controls"
      >
        <div class="vp-row">
          <label for="musicVol" class="small mb-1">Music</label>
          <input id="musicVol" type="range" min="0" max="100" step="1" />
        </div>
        <div class="vp-row">
          <label for="sfxVol" class="small mb-1">SFX</label>
          <input id="sfxVol" type="range" min="0" max="100" step="1" />
        </div>
      </div>
    </aside>

    <!-- External JavaScript Libraries -->
    <!-- Removed unused Vanta/Three scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Local JavaScript Files -->
    <script src="js/utils.js"></script>
    <script src="js/words.js"></script>
    <script src="js/audioManager.js"></script>
    <script src="js/effects.js"></script>
    <script src="js/game.js"></script>

    <!-- Initialize Background Effects -->
    <script>
      // Initialize background effects when DOM loads
      document.addEventListener("DOMContentLoaded", () => {
        if (typeof BackgroundEffects !== "undefined") {
          window.backgroundEffects = new BackgroundEffects();
        }
      });
    </script>

    <!-- Service Worker Registration -->
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", function () {
          navigator.serviceWorker.register("/sw.js").catch(function (err) {
            console.warn("Service worker registration failed:", err);
          });
        });
      }
    </script>
    <!-- Safety fallback: never leave loading screen stuck -->
    <script>
      window.addEventListener("load", function () {
        setTimeout(function () {
          var loader = document.getElementById("loadingScreen");
          if (loader) {
            loader.style.opacity = "0";
            loader.style.display = "none";
          }
          // Only reveal the start section if the game hasn't begun and stats aren't showing
          var start = document.getElementById("startSection");
          var game = document.getElementById("gameSection");
          var stats = document.getElementById("statsSection");
          var gameVisible = game && !game.classList.contains("hidden");
          var statsVisible = stats && !stats.classList.contains("hidden");
          if (!gameVisible && !statsVisible && start) {
            start.classList.remove("hidden");
          }
        }, 6000);
      });
    </script>
  </body>
</html>
